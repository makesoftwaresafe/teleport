---
title: SSH Authentication With Okta as an SSO provider
description: How to configure SSH access using Okta for SSO
h1: SSH Authentication with Okta
videoBanner: SM4Am-i8cj4
---

## How to use Okta as a single sign-on (SSO) provider for SSH

This guide will cover how to configure [Okta](https://www.okta.com/) to issue
SSH credentials to specific groups of users. When used in combination with role
based access control (RBAC), it allows SSH administrators to define policies
like:

- Only members of "DBA" group can SSH into machines running PostgreSQL.
- Developers must never SSH into production servers.

<ScopedBlock
  scope={["oss"]}
>

  This guide requires Teleport Cloud or Teleport Enterprise.

  View this guide as the user of another Teleport edition:

  <TileSet>
  <Tile icon="cloud" title="Teleport Cloud" href="./okta.mdx/?scope=cloud">
  </Tile>
  <Tile icon="building" title="Teleport Enterprise" href="./okta.mdx/?scope=enterprise">
  </Tile>
  </TileSet>

</ScopedBlock>

<ScopedBlock scope={["cloud", "enterprise"]}>

(!docs/pages/includes/enterprise/samlauthentication.mdx!)

## Configure Okta

First, create a SAML 2.0 Web App in Okta configuration section

- Select "Create New App"
- Select "Web Platform" and "SAML 2.0 Sign On Method".

![Create APP](../../../img/sso/okta/okta-saml-1.png)

## Configure the App

We are going to map the Okta groups we've created above to the SAML Attribute
statements (special signed metadata exposed via a SAML XML response).

### Section: *"General"*

Configure general settings section. Make sure there are no typos in the callback URL.

| Field                       | Value                                                       |
|-----------------------------|-------------------------------------------------------------|
| Single sign on URL          | `https://teleport-proxy.example.com:443/v1/webapi/saml/acs` |
| Audience URI (SP Entity ID) | `https://teleport-proxy.example.com:443/v1/webapi/saml/acs` |
| Name ID format              | `EmailAddress`                                              |
| Application username        | `Okta username`                                             |

### Section: *"Single Attribute Statements"*

Configure single-value attributes to be passed to Teleport on login.

| Name       | Name format   | Value        |
|------------|---------------|--------------|
| `username` | `Unspecified` | `user.login` |
| `email`    | `Basic`       | `user.email` |

### Section: *"Group Attribute Statements"*

Configure which group information to be passed to Teleport on login. To pass all groups via the claim named `groups`:

| Name     | Name format   | Filter type     | Filter definition |
|----------|---------------|-----------------|-------------------|
| `groups` | `Unspecified` | `Matches regex` | `.*`              |

<Admonition type="warning" title="Matching all groups">
  The regular expression matching all groups is `.*`. If you leave the filter definition empty it will match no groups.
</Admonition>

### Review

Afterwards the app configuration should look similar to this:

![Configure APP](../../../img/sso/okta/setup-redirection.png)

## Create & Assign Groups

**Create Groups**

We are going to create two groups: "okta-dev" and "okta-admin":

![Create Group Devs](../../../img/sso/okta/okta-saml-2.1.png)

...and the admin:

![Create Group Devs](../../../img/sso/okta/okta-saml-2.2.png)

Assign groups and people to your SAML app:

![Configure APP](../../../img/sso/okta/okta-saml-3.1.png)

Make sure to download the metadata in the form of an XML document and save it (e.g. as `entity_desc.xml`). It will be used it to
configure a Teleport connector:

![Download metadata](../../../img/sso/okta/okta-saml-4.png)

## Create a Developer Teleport Role

We are going to create a new role that'll pull in external information from Okta. Notice
`{{external.username}}` login. It configures Teleport to look at *"username"* Okta claim
and use that field as an allowed login for each user.  This example uses email as the
username format.  The `email.local(external.trait)` function will remove the `@domain`
and just have the username prefix.

```yaml
kind: role
version: v5
metadata:
  name: dev
spec:
  options:
    max_session_ttl: 24h
  allow:
    logins: [ "{{email.local(external.username)}}", ubuntu ]
    node_labels:
      access: relaxed
```

- Devs are only allowed to login to nodes labelled with `access: relaxed` label.
- Developers can log in as `ubuntu` user
- Developers also do not have any "allow rules" i.e. they will not be able to
  see/replay past sessions or re-configure the Teleport cluster.

We'll use tctl to create this role on the auth server:

```bsh
$ tctl create dev.yaml
```

## Create & Test SAML Connector

Now, create a SAML connector [resource](../../setup/reference/resources.mdx).

Use the [`tctl sso configure saml`](../../setup/reference/cli.mdx#tctl-sso-configure-saml) command like so:

```code
$ tctl sso configure saml -p okta -e entity_desc.xml -r groups,okta-admin,editor -r groups,okta-dev,dev \
  | tee okta-connector.yaml
```

The resulting file should be similar to this:

```yaml
(!examples/resources/saml-connector.yaml!)
```

Before creating the connector, you should test it using [`tctl sso test`](../../setup/reference/cli.mdx#tctl-sso-test) command:

```code
$ tctl sso test okta-connector.yaml
```

You can also run both commands as a pipeline:

```code
$ tctl sso configure saml -p okta -e entity_desc.xml -r groups,okta-admin,editor -r groups,okta-dev,dev \
  | tee okta-connector.yaml | tctl sso test
# INFO [CLIENT]    ACS empty, resolving automatically.
# INFO [CLIENT]    ACS set to "https://teleport-proxy.example.com:443/v1/webapi/saml/acs"
# INFO [CLIENT]    Cannot parse entity descriptor as URL, missing scheme: "entity_desc.xml".
# INFO [CLIENT]    Entity descriptor read from file "entity_desc.xml".
# If browser window does not open automatically, open it by clicking on the link:
#  http://127.0.0.1:64847/9d140755-1a1e-4b21-b9d7-11ce0aa1eb6c
# Success! Logged in as: oktauser@example.com
# --------------------------------------------------------------------------------
# Authentication details:
#    roles:
#    - editor
#    - dev
#    traits:
#      email:
#      - oktauser@example.com
#      groups:
#      - Everyone
#      - okta-admin
#      - okta-dev
#      username:
#      - oktauser@example.com
#    username: oktauser@example.com
# --------------------------------------------------------------------------------
# [SAML] Attributes to roles:
# - name: groups
#   roles:
#   - editor
#   value: okta-admin
# - name: groups
#   roles:
#   - dev
#   value: okta-dev
# 
# --------------------------------------------------------------------------------
# [SAML] Attributes statements:
# email:
# - oktauser@example.com
# groups:
# - Everyone
# - okta-admin
# - okta-dev
# username:
# - oktauser@example.com
# 
# --------------------------------------------------------------------------------
# For more details repeat the command with --debug flag.
```

In the example above, we:
1. Configure the SAML connector using `okta` preset.
2. Save the connector to `okta-connector.yaml`.
3. Run end-to-end SSO flow test with `tctl sso test`.
4. When prompted, authenticate as `oktauser@example.com` on Okta login page.
5. Review the diagnostic information, observing that:
   - the login was successful
   - `oktauser@example.com` is member of both `okta-dev` and `okta-admin` Okta groups.
   - there are `email`, `username` and `groups` attribute statements present, matching our configuration of Okta App.

Once happy with the test results, create the connector using `tctl` tool:

```bsh
$ tctl create okta-connector.yaml
```

## Validation

The Web UI will now contain a new button: "Login with Okta". You can also login with `tsh`:

```bsh
$ tsh login --proxy=proxy.example.com --auth=okta
```

This command will print the SSO login URL (and will try to open it
automatically in a browser).

<Admonition
  type="tip"
  title="Tip"
>
  Teleport can use multiple SAML connectors. In this case a connector name
  can be passed via `tsh login --auth=connector_name`
</Admonition>

<Admonition
  type="note"
  title="IMPORTANT"
>
  Teleport only supports sending party initiated flows for SAML 2.0. This
  means you can not initiate login from your identity provider, you have to
  initiate login from either the Teleport Web UI or CLI.
</Admonition>

## Troubleshooting

(!docs/pages/includes/sso/loginerrortroubleshooting.mdx!)

</ScopedBlock>